<%- include('../partials/header', { 
    title: 'All Students - Admin Dashboard',
    breadcrumbs: [
        { text: 'Students', url: '/students' },
        { text: 'All Students' }
    ]
}) %>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-users me-2"></i>All Students
                </h4>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="exportToCSV()">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="printTable()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Filter Section -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Search students or parents...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="gradeFilter">
                            <option value="">All Grades</option>
                            <option value="Form I">Form I</option>
                            <option value="Form II">Form II</option>
                            <option value="Form III">Form III</option>
                            <option value="Form IV">Form IV</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="sortBy">
                            <option value="grade">Sort by Grade</option>
                            <option value="name">Sort by Name</option>
                            <option value="parent">Sort by Parent</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Students</h5>
                                <h3 id="totalStudents"><%= students.length %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">Form I</h5>
                                <h3 id="form1Count"><%= students.filter(s => s.grade === 'Form I').length %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">Form II</h5>
                                <h3 id="form2Count"><%= students.filter(s => s.grade === 'Form II').length %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">Form III & IV</h5>
                                <h3 id="form34Count"><%= students.filter(s => s.grade === 'Form III' || s.grade === 'Form IV').length %></h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="studentsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Index No</th>
                                <th>Student Name</th>
                                <th>Grade</th>
                                <th>Parent Name</th>
                                <th>Parent Email</th>
                                <th>Parent Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (students.length === 0) { %>
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No students found
                                </td>
                            </tr>
                            <% } else { %>
                                <% students.forEach(student => { %>
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary"><%= student.index_no %></span>
                                    </td>
                                    <td>
                                        <strong><%= student.first_name %> <%= student.last_name %></strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary"><%= student.grade %></span>
                                    </td>
                                    <td>
                                        <i class="fas fa-user me-1"></i><%= student.parent_name %>
                                    </td>
                                    <td>
                                        <a href="mailto:<%= student.parent_email %>" class="text-decoration-none">
                                            <i class="fas fa-envelope me-1"></i><%= student.parent_email %>
                                        </a>
                                    </td>
                                    <td>
                                        <% if (student.parent_approved) { %>
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Approved
                                            </span>
                                        <% } else { %>
                                            <span class="badge bg-warning">
                                                <i class="fas fa-clock me-1"></i>Pending
                                            </span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    onclick="viewStudent(<%= student.id %>)" 
                                                    title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-info" 
                                                    onclick="contactParent('<%= student.parent_email %>')" 
                                                    title="Contact Parent">
                                                <i class="fas fa-comment"></i>
                                            </button>
                                            <button class="btn btn-outline-success" 
                                                    onclick="viewParent('<%= student.parent_id %>')" 
                                                    title="View Parent">
                                                <i class="fas fa-user-friends"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <% }); %>
                            <% } %>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted">
                        Showing <span id="showingCount"><%= students.length %></span> of <span id="totalCount"><%= students.length %></span> students
                    </div>
                    <nav aria-label="Students pagination">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Details Modal -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="studentModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Search and filter functionality
function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const gradeFilter = document.getElementById('gradeFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    
    const rows = document.querySelectorAll('#studentsTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (row.cells.length === 1) return; // Skip "no students" row
        
        const studentName = (row.cells[1].textContent || '').toLowerCase();
        const grade = row.cells[2].textContent;
        const parentName = (row.cells[3].textContent || '').toLowerCase();
        const parentEmail = (row.cells[4].textContent || '').toLowerCase();
        
        const matchesSearch = !searchTerm || 
            studentName.includes(searchTerm) || 
            parentName.includes(searchTerm) || 
            parentEmail.includes(searchTerm);
        
        const matchesGrade = !gradeFilter || grade.includes(gradeFilter);
        
        if (matchesSearch && matchesGrade) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    document.getElementById('showingCount').textContent = visibleCount;
}

// Export to CSV
function exportToCSV() {
    const table = document.getElementById('studentsTable');
    const rows = Array.from(table.querySelectorAll('tr'));
    
    let csv = 'Index No,Student Name,Grade,Parent Name,Parent Email,Parent Status\n';
    
    rows.slice(1).forEach(row => {
        if (row.style.display !== 'none' && row.cells.length > 1) {
            const rowData = Array.from(row.cells).slice(0, 6).map(cell => {
                return '"' + cell.textContent.replace(/"/g, '""') + '"';
            });
            csv += rowData.join(',') + '\n';
        }
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'students_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Print table
function printTable() {
    const printWindow = window.open('', '_blank');
    const table = document.getElementById('studentsTable').cloneNode(true);
    
    printWindow.document.write(`
        <html>
            <head>
                <title>Students Report</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        .btn-group { display: none !important; }
                        .pagination { display: none !important; }
                    }
                </style>
            </head>
            <body>
                <div class="container mt-4">
                    <h2>Students Report - Dr. Salmin Amour Sec. School</h2>
                    <p class="text-muted">Generated on: ${new Date().toLocaleDateString()}</p>
                    ${table.outerHTML}
                </div>
            </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}

// View student details
function viewStudent(studentId) {
    // This would typically fetch student details via AJAX
    const modal = new bootstrap.Modal(document.getElementById('studentModal'));
    document.getElementById('studentModalBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    modal.show();
    
    // Simulate loading student details
    setTimeout(() => {
        document.getElementById('studentModalBody').innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Student details functionality would be implemented here.
            </div>
        `;
    }, 1000);
}

// Contact parent
function contactParent(email) {
    window.location.href = `/messages/new?to=${encodeURIComponent(email)}`;
}

// View parent details
function viewParent(parentId) {
    window.location.href = `/users/${parentId}`;
}

// Search on input change
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('gradeFilter').addEventListener('change', applyFilters);
document.getElementById('sortBy').addEventListener('change', applyFilters);

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script> 