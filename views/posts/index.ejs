<%- include('../partials/header', { 
    title: 'Announcements - Dr. Salmin Amour Sec. School',
    breadcrumbs: [{ text: 'Announcements' }]
}) %>

<% if (!user) { %>
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Public View:</strong> You're viewing general announcements only. 
    <a href="/auth/login" class="alert-link">Login</a> or 
    <a href="/auth/register" class="alert-link">Register</a> to see all announcements and interact with posts.
</div>
<% } %>

<div class="row">
    <div class="col-lg-8">
        <!-- Search and Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" action="/posts" class="row g-3">
                    <div class="col-md-6">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="<%= search %>" placeholder="Search announcements...">
                    </div>
                    <div class="col-md-4">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="all" <%= currentCategory === 'all' ? 'selected' : '' %>>All Categories</option>
                            <option value="announcement" <%= currentCategory === 'announcement' ? 'selected' : '' %>>Announcements</option>
                            <option value="event" <%= currentCategory === 'event' ? 'selected' : '' %>>Events</option>
                            <option value="news" <%= currentCategory === 'news' ? 'selected' : '' %>>News</option>
                            <option value="general" <%= currentCategory === 'general' ? 'selected' : '' %>>General</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i>Search
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Posts List -->
        <% if (posts && posts.length > 0) { %>
            <% posts.forEach(post => { %>
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge badge-<%= post.category %> me-2">
                            <%= post.category.charAt(0).toUpperCase() + post.category.slice(1) %>
                        </span>
                        <% if (post.visibility === 'teachers') { %>
                        <span class="badge bg-info me-2">
                            <i class="fas fa-chalkboard-teacher me-1"></i>Teachers Only
                        </span>
                        <% } else if (post.visibility === 'parents') { %>
                        <span class="badge bg-success me-2">
                            <i class="fas fa-user-friends me-1"></i>Parents Only
                        </span>
                        <% } %>
                        <% if (post.is_pinned) { %>
                        <span class="badge bg-warning text-dark me-2">
                            <i class="fas fa-thumbtack me-1"></i>Pinned
                        </span>
                        <% } %>
                        <% if (post.class_name) { %>
                        <span class="badge bg-secondary me-2">
                            <i class="fas fa-graduation-cap me-1"></i><%= post.class_name %>
                        </span>
                        <% } %>
                                                 <small class="text-muted">
                             <i class="fas fa-user me-1"></i><%= post.author_name %>
                             <% if (post.author_role === 'admin') { %>
                                 <span class="badge bg-danger ms-1"><%= post.author_role %></span>
                             <% } else if (post.author_role === 'teacher') { %>
                                 <span class="badge bg-primary ms-1"><%= post.author_role %></span>
                             <% } else { %>
                                 <span class="badge bg-success ms-1"><%= post.author_role %></span>
                             <% } %>
                         </small>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>
                        <%= new Date(post.created_at).toLocaleDateString() %>
                    </small>
                </div>
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="/posts/<%= post.id %>" class="text-decoration-none">
                            <%= post.title %>
                        </a>
                    </h5>
                    <p class="card-text">
                        <%= post.content.length > 200 ? post.content.substring(0, 200) + '...' : post.content %>
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <small class="text-muted">
                                <i class="fas fa-comments me-1"></i><%= post.comment_count %> comments
                            </small>
                            <% if (user) { %>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm <%= post.userReaction === 'like' ? 'btn-success' : 'btn-outline-success' %> react-btn" 
                                        data-post-id="<%= post.id %>" data-reaction="like">
                                    <i class="fas fa-thumbs-up me-1"></i>
                                    <span class="like-count"><%= post.like_count || 0 %></span>
                                </button>
                                <button class="btn btn-sm <%= post.userReaction === 'dislike' ? 'btn-danger' : 'btn-outline-danger' %> react-btn" 
                                        data-post-id="<%= post.id %>" data-reaction="dislike">
                                    <i class="fas fa-thumbs-down me-1"></i>
                                    <span class="dislike-count"><%= post.dislike_count || 0 %></span>
                                </button>
                                <% if (user.role === 'admin') { %>
                                <button class="btn btn-sm btn-outline-info" onclick="showReactionDetails(<%= post.id %>)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <% } %>
                            </div>
                            <% } else { %>
                            <div class="d-flex align-items-center gap-2">
                                <span class="text-muted">
                                    <i class="fas fa-thumbs-up me-1"></i><%= post.like_count || 0 %>
                                </span>
                                <span class="text-muted">
                                    <i class="fas fa-thumbs-down me-1"></i><%= post.dislike_count || 0 %>
                                </span>
                            </div>
                            <% } %>
                        </div>
                        <a href="/posts/<%= post.id %>" class="btn btn-sm btn-outline-primary">
                            Read More <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
            <% }); %>
        <% } else { %>
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5>No announcements found</h5>
                    <p class="text-muted">
                        <% if (search || currentCategory !== 'all') { %>
                            Try adjusting your search criteria.
                        <% } else { %>
                            No announcements have been posted yet.
                        <% } %>
                    </p>
                </div>
            </div>
        <% } %>
    </div>
    
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <% if (user && user.role === 'admin') { %>
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/posts/new" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Create New Post
                    </a>
                </div>
            </div>
        </div>
        <% } %>
        
        <!-- Categories -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tags me-2"></i>Categories
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <a href="/posts" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        All Posts
                        <span class="badge bg-primary rounded-pill"><%= posts ? posts.length : 0 %></span>
                    </a>
                    <a href="/posts?category=announcement" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span class="badge badge-announcement me-2">Announcement</span>
                        Announcements
                    </a>
                    <a href="/posts?category=event" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span class="badge badge-event me-2">Event</span>
                        Events
                    </a>
                    <a href="/posts?category=news" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span class="badge badge-news me-2">News</span>
                        News
                    </a>
                    <a href="/posts?category=general" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span class="badge badge-general me-2">General</span>
                        General
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle like/dislike button clicks
    document.querySelectorAll('.react-btn').forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            
            const postId = this.dataset.postId;
            const reaction = this.dataset.reaction;
            const card = this.closest('.card');
            
            try {
                const response = await fetch(`/posts/${postId}/react`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reaction_type: reaction })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update like count
                    const likeBtn = card.querySelector('[data-reaction="like"]');
                    const likeCount = likeBtn.querySelector('.like-count');
                    likeCount.textContent = data.likes;
                    
                    // Update dislike count
                    const dislikeBtn = card.querySelector('[data-reaction="dislike"]');
                    const dislikeCount = dislikeBtn.querySelector('.dislike-count');
                    dislikeCount.textContent = data.dislikes;
                    
                    // Update button styles based on user reaction
                    if (data.userReaction === 'like') {
                        likeBtn.className = 'btn btn-sm btn-success react-btn';
                        dislikeBtn.className = 'btn btn-sm btn-outline-danger react-btn';
                    } else if (data.userReaction === 'dislike') {
                        likeBtn.className = 'btn btn-sm btn-outline-success react-btn';
                        dislikeBtn.className = 'btn btn-sm btn-danger react-btn';
                    } else {
                        likeBtn.className = 'btn btn-sm btn-outline-success react-btn';
                        dislikeBtn.className = 'btn btn-sm btn-outline-danger react-btn';
                    }
                } else {
                    console.error('Error:', response.statusText);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });
});

// Function to show reaction details modal
function showReactionDetails(postId) {
    fetch(`/posts/${postId}/reactions`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReactionModal(data);
            } else {
                alert('Error loading reaction details');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading reaction details');
        });
}

// Function to display reaction details in modal
function displayReactionModal(data) {
    const modal = document.getElementById('reactionDetailsModal');
    const modalTitle = document.getElementById('reactionModalTitle');
    const likesList = document.getElementById('likesList');
    const dislikesList = document.getElementById('dislikesList');
    
    modalTitle.textContent = `Reaction Details (${data.total_likes} likes, ${data.total_dislikes} dislikes)`;
    
    // Populate likes
    likesList.innerHTML = '';
    if (data.likes.length > 0) {
        data.likes.forEach(like => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <div>
                    <strong>${like.user_name}</strong>
                    <span class="badge bg-${like.user_role === 'admin' ? 'danger' : like.user_role === 'teacher' ? 'primary' : 'success'} ms-2">${like.user_role}</span>
                    <br><small class="text-muted">${like.user_email}</small>
                </div>
                <small class="text-muted">${new Date(like.created_at).toLocaleString()}</small>
            `;
            likesList.appendChild(item);
        });
    } else {
        likesList.innerHTML = '<div class="list-group-item text-muted">No likes yet</div>';
    }
    
    // Populate dislikes
    dislikesList.innerHTML = '';
    if (data.dislikes.length > 0) {
        data.dislikes.forEach(dislike => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <div>
                    <strong>${dislike.user_name}</strong>
                    <span class="badge bg-${dislike.user_role === 'admin' ? 'danger' : dislike.user_role === 'teacher' ? 'primary' : 'success'} ms-2">${dislike.user_role}</span>
                    <br><small class="text-muted">${dislike.user_email}</small>
                </div>
                <small class="text-muted">${new Date(dislike.created_at).toLocaleString()}</small>
            `;
            dislikesList.appendChild(item);
        });
    } else {
        dislikesList.innerHTML = '<div class="list-group-item text-muted">No dislikes yet</div>';
    }
    
    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}
</script>

<!-- Reaction Details Modal -->
<div class="modal fade" id="reactionDetailsModal" tabindex="-1" aria-labelledby="reactionModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reactionModalTitle">Reaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">
                            <i class="fas fa-thumbs-up me-2"></i>Likes
                        </h6>
                        <div class="list-group" id="likesList">
                            <!-- Likes will be populated here -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger">
                            <i class="fas fa-thumbs-down me-2"></i>Dislikes
                        </h6>
                        <div class="list-group" id="dislikesList">
                            <!-- Dislikes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div> 